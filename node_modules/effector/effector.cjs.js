function e(e,t){for(let r in e)t(e[r],r)}function t(e,t){e.forEach(t)}function r(e,t){if(!e)throw Error(t)}function a(e,t){Q={parent:Q,value:e,template:T(e,'template')||X(),sidRoot:T(e,'sidRoot')||Q&&Q.sidRoot};try{return t()}finally{Q=B(Q)}}function n({node:e=[],from:r,source:a,parent:n=r||a,to:o,target:s,child:i=o||s,scope:l={},meta:f={},family:c={type:'regular'},regional:d}={}){let u=ee(n),p=ee(c.links),m=ee(c.owners),h=[];t(e,(e=>e&&z(h,e)));let g={id:K(),seq:h,next:ee(i),meta:f,scope:l,family:{type:c.type||"crosslink",links:p,owners:m}};return t(p,(e=>z(R(e),g))),t(m,(e=>z(_(e),g))),t(u,(e=>z(e.next,g))),d&&Q&&Z(E(Q),[g]),g}function o(e,r,a){let n=Re,o=null,s=qe;if(e.target&&(r=e.params,a=e.defer,n='page'in e?e.page:n,e.stack&&(o=e.stack),s=L(e)||s,e=e.target),s&&qe&&s!==qe&&(qe=null),Array.isArray(e))for(let t=0;t<e.length;t++)Ne('pure',n,D(e[t]),o,r[t],s);else Ne('pure',n,D(e),o,r,s);if(a&&!ze)return;let i,l,f,c,d,u,p={isRoot:ze,currentPage:Re,scope:qe,isWatch:Fe,isPure:De};ze=0;e:for(;c=Me();){let{idx:e,stack:r,type:a}=c;f=r.node,Re=d=r.page,qe=L(r),d?u=d.reg:qe&&(u=qe.reg);let n=!!d,o=!!qe,s={fail:0,scope:f.scope};i=l=0;for(let t=e;t<f.seq.length&&!i;t++){let c=f.seq[t];if(c.order){let{priority:n,barrierID:o}=c.order,s=o?d?`${d.fullID}_${o}`:o:0;if(t!==e||a!==n){o?Oe.has(s)||(Oe.add(s),Ae(t,r,n,o)):Ae(t,r,n);continue e}o&&Oe.delete(s)}switch(c.type){case'mov':{let e,t=c.data;switch(t.from){case w:e=E(r);break;case"a":case'b':e=r[t.from];break;case"value":e=t.store;break;case"store":if(u&&!u[t.store.id])if(n){let e=Ee(d,t.store.id);r.page=d=e,e?u=e.reg:o?(Be(qe,t.store,0,1,t.softRead),u=qe.reg):u=void 0}else o&&Be(qe,t.store,0,1,t.softRead);e=ke(u&&u[t.store.id]||t.store)}switch(t.to){case w:r.value=e;break;case"a":case'b':r[t.to]=e;break;case"store":Ve(d,qe,f,t.target).current=e}break}case'compute':let e=c.data;if(e.fn){Fe='watch'===T(f,'op'),De=e.pure;let t=e.safe?(0,e.fn)(E(r),s.scope,r):Le(s,e.fn,r);e.filter?l=!t:r.value=t,Fe=p.isWatch,De=p.isPure}}i=s.fail||l}if(!i){let e=E(r);t(f.next,(t=>{Ne('child',d,t,r,e,L(r))}));let a=L(r);if(a){T(f,'needFxCounter')&&Ne('child',d,a.fxCount,r,e,a),T(f,'storeChange')&&Ne('child',d,a.storeChange,r,e,a),T(f,'warnSerialize')&&Ne('child',d,a.warnSerializeNode,r,e,a);let n=a.additionalLinks[f.id];n&&t(n,(t=>{Ne('child',d,t,r,e,a)}))}}}ze=p.isRoot,Re=p.currentPage,qe=L(p)}function s(t,r="combine"){let a=r+'(',n='',o=0;return e(t,(e=>{o<25&&(null!=e&&(a+=n,a+=S(e)?H(e).fullName:e.toString()),o+=1,n=', ')})),a+')'}function i(e,t){let r,a,n=e;if(t){let n=H(t);0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)}else r=0===e.length?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function l(e,t){let r=t?e:e[0];ne(r);let a=r.or,n=r.and;if(n){let r=t?n:n[0];if(te(r)&&'and'in r){let r=l(n,t);e=r[0],a={...a,...r[1]}}else e=n}return[e,a]}function f(e,...t){let r=X();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function c(e,t){let r=(e,...t)=>(F(!T(r,'derived'),'call of derived event','createEvent'),F(!De,'unit call from pure function','operators like sample'),Re?((e,t,r,a)=>{let n=Re,o=null;if(t)for(o=Re;o&&o.template!==t;)o=B(o);Pe(o);let s=e.create(r,a);return Pe(n),s})(r,a,e,t):r.create(e,t)),a=X();return Object.assign(r,{graphite:n({meta:Ye("event",r,e,t),regional:1}),create:e=>(o({target:r,params:e,scope:qe}),e),watch:e=>Qe(r,e),map:e=>Ze(r,k,e,[be()]),filter:e=>Ze(r,"filter",e.fn?e:e.fn,[be(ce,1)]),filterMap:e=>Ze(r,'filterMap',e,[be(),ge((e=>!ae(e)),1)]),prepend(e){let t=c('* \u2192 '+r.shortName,{parent:B(r)});return f('eventPrepend',D(t)),Ke(t,r,[be()],'prepend',e),Xe(r,t),t}})}function d(e,a){let s=xe(e),i=c({named:'updates',derived:1});f('storeBase',s);let l=s.id,u={subscribers:new Map,updates:i,defaultState:e,stateRef:s,getState(){let e,t=s;if(Re){let t=Re;for(;t&&!t.reg[l];)t=B(t);t&&(e=t)}return!e&&qe&&(Be(qe,s,1),e=qe),e&&(t=e.reg[l]),ke(t)},setState:e=>o({target:u,params:e,defer:1,scope:qe}),reset:(...e)=>(t(e,(e=>u.on(e,(()=>u.defaultState)))),u),on:(e,r)=>(se(e,'.on','first argument'),F(!T(u,'derived'),'.on in derived store','createStore'),t(Array.isArray(e)?e:[e],(e=>{u.off(e),V(u).set(e,Je(et(e,u,'on',fe,r)))})),u),off(e){let t=V(u).get(e);return t&&(t(),V(u).delete(e)),u},map(e,t){let r,a;te(e)&&(r=e,e=e.fn),F(ae(t),'second argument of store.map','updateFilter');let n=u.getState();X()?a=null:ae(n)||(a=e(n,t));let o=d(a,{name:`${u.shortName} \u2192 *`,derived:1,and:r}),i=et(u,o,k,le,e);return we(P(o),{type:k,fn:e,from:s}),P(o).noInit=1,f('storeMap',s,i),o},watch(e,t){if(!t||!S(e)){let t=Qe(u,e);return f('storeWatch',s,e)||e(u.getState()),t}return r(re(t),'second argument should be a function'),e.watch((e=>t(u.getState(),e)))}},p=Ye("store",u,a),m=u.defaultConfig.updateFilter;u.graphite=n({scope:{state:s,fn:m},node:[ge(((e,t,r)=>(r.scope&&!r.scope.reg[s.id]&&(r.b=1),e))),ye(s),ge(((e,t,{a:r,b:a})=>!ae(e)&&(e!==r||a)),1),m&&be(le,1),pe({from:w,target:s})],child:i,meta:p,regional:1});let h=T(u,'derived'),g='ignore'===T(u,'serialize'),y=T(u,'sid');return y&&(g||W(u,'storeChange',1),s.sid=y),y||g||h||W(u,'warnSerialize',1),r(h||!ae(e),"current state can't be undefined, use null instead"),Z(u,[i]),u}function u(...e){let t,a,n;[e,n]=l(e);let o,s,i,f=e[e.length-1];if(re(f)?(a=e.slice(0,-1),t=f):a=e,1===a.length){let e=a[0];C(e)||(o=e,s=1)}if(!s&&(o=a,t)){i=1;let e=t;t=t=>e(...t)}return r(te(o),'shape should be an object'),tt(Array.isArray(o),!i,o,n,t)}function p(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function m(e,t){let a=c(re(e)?{handler:e}:e,t),s=D(a);W(s,'op',a.kind="effect"),a.use=e=>(r(re(e),'.use argument should be a function'),h.scope.handler=e,a),a.use.getCurrent=()=>h.scope.handler;let i=a.finally=c({named:'finally',derived:1}),l=a.done=i.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=a.fail=i.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),u=a.doneData=l.map({named:'doneData',fn:({result:e})=>e}),m=a.failData=f.map({named:'failData',fn:({error:e})=>e}),h=n({scope:{handlerId:T(s,'sid'),handler:a.defaultConfig.handler||(()=>r(0,`no handler used in ${a.getType()}`))},node:[ge(((e,t,r)=>{let a=t,n=a.handler;if(L(r)){let e=L(r).handlers[a.handlerId];e&&(n=e)}return e.handler=n,e}),0,1),ge((({params:e,req:t,handler:r,args:a=[e]},n,o)=>{let s=at(e,t,1,i,o),l=at(e,t,0,i,o),[f,c]=rt(r,l,a);f&&(te(c)&&re(c.then)?c.then(s,l):s(c))}),0,1)],meta:{op:'fx',fx:'runner'}});s.scope.runner=h,z(s.seq,ge(((e,{runner:t},r)=>{let a=B(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return o({target:t,params:a,defer:1,scope:L(r)}),a.params}),0,1)),a.create=e=>{let t=p(),r={params:e,req:t};if(qe){if(!Fe){let e=qe;t.req.finally((()=>{_e(e)})).catch((()=>{}))}o({target:a,params:r,scope:qe})}else o(a,r);return t.req};let g=a.inFlight=d(0,{serialize:'ignore'}).on(a,(e=>e+1)).on(i,(e=>e-1)).map({fn:e=>e,named:'inFlight'});W(i,'needFxCounter','dec'),W(a,'needFxCounter',1);let y=a.pending=g.map({fn:e=>e>0,named:'pending'});return Z(a,[i,l,f,u,m,y,g]),a}function h(e,t){se(e,'merge','first argument');let r=c({name:s(e,'merge'),derived:1,and:t});return Ke(e,r,[],'merge'),r}function g(e,a){let n=0;return t(ot,(t=>{t in e&&(r(null!=e[t],st(a,t)),n=1)})),n}function y(e,r){let a=[];(function e(n){O(a,n)||(z(a,n),"store"===T(n,'op')&&T(n,'sid')&&r(n,T(n,'sid')),t(n.next,e),t(R(n),e),t(_(n),e))})(e)}function b(e,a){if(Array.isArray(e)&&(e=new Map(e)),e instanceof Map){let n={};return t(e,((e,t)=>{r(S(t),'Map key should be a unit'),a&&a(t,e),r(t.sid,'unit should have a sid'),r(!(t.sid in n),'duplicate sid found'),n[t.sid]=e})),n}return e}function v(e){let t=()=>e();return t.unsubscribe=()=>e(),t}Object.defineProperty(exports,'__esModule',{value:1});let x='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',k='map',w='stack',S=e=>(re(e)||te(e))&&'kind'in e;const j=e=>t=>S(t)&&t.kind===e;let C=j("store"),$=j("event"),M=j("effect"),N=j("domain"),A=j("scope");var I={__proto__:null,unit:S,store:C,event:$,effect:M,domain:N,scope:A};let O=(e,t)=>e.includes(t),q=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},z=(e,t)=>e.push(t),F=(e,t,r)=>!e&&console.error(`${t} is deprecated${r?`, use ${r} instead`:''}`),D=e=>e.graphite||e,R=e=>e.family.owners,_=e=>e.family.links,P=e=>e.stateRef,E=e=>e.value,V=e=>e.subscribers,B=e=>e.parent,L=e=>e.scope,T=(e,t)=>D(e).meta[t],W=(e,t,r)=>D(e).meta[t]=r,H=e=>e.compositeName;const U=()=>{let e=0;return()=>""+ ++e};let G=U(),J=U(),K=U(),Q=null,X=()=>Q&&Q.template,Y=e=>(e&&Q&&Q.sidRoot&&(e=`${Q.sidRoot}|${e}`),e),Z=(e,r)=>{let a=D(e);t(r,(e=>{let t=D(e);"domain"!==a.family.type&&(t.family.type="crosslink"),z(R(t),a),z(_(a),t)}))},ee=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(D),te=e=>'object'==typeof e&&null!==e,re=e=>'function'==typeof e,ae=e=>void 0===e,ne=e=>r(te(e)||re(e),'expect first argument be an object');const oe=(e,t,a,n)=>r(!(!te(e)&&!re(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${a} to be a unit (store, event or effect)${n}`);let se=(e,r,a)=>{Array.isArray(e)?t(e,((e,t)=>oe(e,r,`${t} item of ${a}`,''))):oe(e,r,a,' or array of units')},ie=(e,r,a="target")=>t(ee(r),(t=>F(!T(t,'derived'),`${e}: derived unit in "${a}"`,"createEvent/createStore"))),le=(e,{fn:t},{a:r})=>t(e,r),fe=(e,{fn:t},{a:r})=>t(r,e),ce=(e,{fn:t})=>t(e);const de=(e,t,r,a)=>{let n={id:J(),type:e,data:t};return r&&(n.order={priority:r},a&&(n.order.barrierID=++ue)),n};let ue=0,pe=({from:e="store",store:t,target:r,to:a=(r?"store":w),batch:n,priority:o})=>de('mov',{from:e,store:t,to:a,target:r},o,n),me=({fn:e,batch:t,priority:r,safe:a=0,filter:n=0,pure:o=0})=>de('compute',{fn:e,safe:a,filter:n,pure:o},r,t),he=({fn:e})=>me({fn:e,priority:"effect"}),ge=(e,t,r)=>me({fn:e,safe:1,filter:t,priority:r&&"effect"}),ye=(e,t,r)=>pe({store:e,to:t?w:"a",priority:r&&"sampler",batch:1}),be=(e=ce,t)=>me({fn:e,pure:1,filter:t}),ve={mov:pe,compute:me,filter:({fn:e,pure:t})=>me({fn:e,filter:1,pure:t}),run:he},xe=e=>({id:J(),current:e}),ke=({current:e})=>e,we=(e,t)=>{e.before||(e.before=[]),z(e.before,t)},Se=null;const je=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Ie(e.v.type)>Ie(t.v.type))&&(r=e,e=t,t=r),r=je(e.r,t),e.r=e.l,e.l=r,e},Ce=[];let $e=0;for(;$e<6;)z(Ce,{first:null,last:null,size:0}),$e+=1;const Me=()=>{for(let e=0;e<6;e++){let t=Ce[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=Se.v;return Se=je(Se.l,Se.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Ne=(e,t,r,a,n,o)=>Ae(0,{a:null,b:null,node:r,parent:a,value:n,page:t,scope:o},e),Ae=(e,t,r,a=0)=>{let n=Ie(r),o=Ce[n],s={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};3===n||4===n?Se=je(Se,s):(0===o.size?o.first=s:o.last.r=s,o.last=s),o.size+=1},Ie=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},Oe=new Set;let qe,ze=1,Fe=0,De=0,Re=null,_e=e=>{qe=e},Pe=e=>{Re=e};const Ee=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=B(e);if(e)return e}return null};let Ve=(e,t,r,a,n)=>{let o=Ee(e,a.id);return o?o.reg[a.id]:t?(Be(t,a,n),t.reg[a.id]):a},Be=(e,r,a,n,o)=>{let s=e.reg,i=r.sid;if(s[r.id])return;let l={id:r.id,current:r.current};if(i&&i in e.sidValuesMap&&!(i in e.sidIdMap))l.current=e.sidValuesMap[i];else if(r.before&&!o){let o=0,i=a||!r.noInit||n;t(r.before,(t=>{switch(t.type){case k:{let r=t.from;if(r||t.fn){r&&Be(e,r,a,n);let o=r&&s[r.id].current;i&&(l.current=t.fn?t.fn(o):o)}break}case'field':o||(o=1,l.current=Array.isArray(l.current)?[...l.current]:{...l.current}),Be(e,t.from,a,n),i&&(l.current[t.field]=s[s[t.from.id].id].current)}}))}i&&(e.sidIdMap[i]=r.id),s[r.id]=l};const Le=(e,t,r)=>{try{return t(E(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let Te=(t,r={})=>(te(t)&&(Te(t.or,r),e(t,((e,t)=>{ae(e)||'or'===t||'and'===t||(r[t]=e)})),Te(t.and,r)),r);const We=(e,t)=>{q(e.next,t),q(R(e),t),q(_(e),t)},He=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=_(e);for(;a=n.pop();)We(a,e),(t||r&&'sample'!==T(e,'op')||"crosslink"===a.family.type)&&He(a,t,'on'!==T(a,'op')&&r);for(n=R(e);a=n.pop();)We(a,e),r&&"crosslink"===a.family.type&&He(a,t,'on'!==T(a,'op')&&r)},Ue=e=>e.clear();let Ge=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),C(e))Ue(V(e));else if(N(e)){r=1;let t=e.history;Ue(t.events),Ue(t.effects),Ue(t.stores),Ue(t.domains)}He(D(e),!!t,r)},Je=e=>{let t=()=>Ge(e);return t.unsubscribe=t,t},Ke=(e,t,r,a,o)=>n({node:r,parent:e,child:t,scope:{fn:o},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),Qe=(e,t)=>(r(re(t),'.watch argument should be a function'),Je(n({scope:{fn:t},node:[he({fn:ce})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),Xe=(e,t,r="event")=>{B(e)&&B(e).hooks[r](t)},Ye=(e,t,r,a)=>{let n="domain"===e,o=G(),s=Te({or:a,and:'string'==typeof r?{name:r}:r}),{parent:l=null,sid:f=null,named:c=null}=s,d=c||s.name||(n?'':o),u=i(d,l),p={op:t.kind=e,name:t.shortName=d,sid:t.sid=Y(f),named:c,unitId:t.id=o,serialize:s.serialize,derived:s.derived,config:s};if(t.parent=l,t.compositeName=u,t.defaultConfig=s,t.thru=e=>(F(0,'thru','js pipe'),e(t)),t.getType=()=>u.fullName,!n){t.subscribe=e=>(ne(e),t.watch(re(e)?e:t=>e.next&&e.next(t))),t[x]=()=>t;let e=X();e&&(p.nativeTemplate=e)}return p};const Ze=(e,t,r,a)=>{let n;te(r)&&(n=r,r=r.fn);let o=c({name:`${e.shortName} \u2192 *`,derived:1,and:n});return Ke(e,o,a,t,r),o},et=(e,t,r,a,n)=>{let o=P(t),s=pe({store:o,to:"a",priority:'read'});r===k&&(s.data.softRead=1);let i=[s,be(a)];return f('storeOnMap',o,i,C(e)&&P(e)),Ke(e,t,i,r,n)},tt=(t,a,n,o,i)=>{let l=t?e=>e.slice():e=>({...e}),c=t?[]:{},u=l(c),p=xe(u),m=xe(1);p.type=t?'list':'shape',p.noInit=1,f('combineBase',p,m);let h=d(u,{name:s(n),derived:1,and:o}),g=P(h);g.noInit=1,W(h,'isCombine',1);let y=ye(p);y.order={priority:'barrier'};let b=[ge(((e,t,r)=>(r.scope&&!r.scope.reg[p.id]&&(r.c=1),e))),y,pe({store:m,to:'b'}),ge(((e,{key:t},r)=>{if(r.c||e!==r.a[t])return a&&r.b&&(r.a=l(r.a)),r.a[t]=e,1}),1),pe({from:"a",target:p}),pe({from:"value",store:0,target:m}),pe({from:"value",store:1,target:m,priority:"barrier",batch:1}),ye(p,1),i&&be()];return e(n,((e,t)=>{if(!C(e))return r(!S(e)&&!ae(e),`combine expects a store in a field ${t}`),void(u[t]=c[t]=e);c[t]=e.defaultState,u[t]=e.getState();let a=Ke(e,h,b,'combine',i);a.scope.key=t;let n=P(e);we(p,{type:'field',field:t,from:n}),f('combineField',n,a)})),h.defaultShape=n,we(g,{type:k,from:p,fn:i}),X()||(h.defaultState=i?g.current=i(u):c),h};let rt=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},at=(e,t,r,a,n)=>s=>o({target:[a,nt],params:[r?{status:'done',params:e,result:s}:{status:'fail',params:e,error:s},{value:s,fn:r?t.rs:t.rj}],defer:1,page:n.page,scope:L(n)});const nt=n({node:[he({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}}),ot=['source','clock','target'],st=(e,t)=>e+`: ${t} should be defined`;let lt=(e,t,a,n,o,s,i,l,p,m,g,y)=>{let b=!!o;r(!ae(a)||!ae(t),st(e,'either source or clock'));let v=0;ae(a)?v=1:S(a)||(a=u(a)),ae(t)?t=a:(se(t,e,'clock'),Array.isArray(t)&&(t=h(t))),v&&(a=t),l||i||(i=a.shortName);let x='none';(g||n)&&(S(n)?x='unit':(r(re(n),'`filter` should be function or unit'),x='fn')),o?(se(o,e,'target'),ie(e,o)):'none'===x&&m&&C(a)&&C(t)?o=d(s?s(ke(P(a)),ke(P(t))):ke(P(a)),{name:i,sid:y,or:l}):(o=c({name:i,derived:1,or:l}),f('sampleTarget',D(o)));let k=xe(),j=[];if('unit'===x){let[r,a]=ct(n,o,t,k,e);j=[...ft(a),...ft(r)]}let[$,M]=ct(a,o,t,k,e);return Z(a,[Ke(t,o,[f('sampleSourceLoader'),pe({from:w,target:k}),...ft(M),ye($,1,p),...j,ye(k),'fn'===x&&be(((e,t,{a:r})=>n(e,r)),1),s&&be(le),f('sampleSourceUpward',b)],e,s)]),o};const ft=e=>[ye(e),ge(((e,t,{a:r})=>r),1)],ct=(e,t,r,a,o)=>{let s=C(e),i=s?P(e):xe(),l=xe(s);return s||n({parent:e,node:[pe({from:w,target:i}),pe({from:"value",store:1,target:l})],family:{owners:[e,t,r],links:t},meta:{op:o},regional:1}),f('sampleSource',l,i,a),[i,l]},dt=(e,t,r,a)=>{let n=e[t];n&&o({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})};exports.allSettled=(e,{scope:t,params:r})=>{if(!S(e))return Promise.reject(new Error('first argument should be unit'));if(!M(e)&&!$(e)&&!C(e))return Promise.reject(new Error('first argument accepts only effects, events and stores'));let a=p();a.parentFork=qe;let{fxCount:n}=t;z(n.scope.defers,a);let s=[e],i=[];return z(i,M(e)?{params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}:r),z(s,n),z(i,null),o({target:s,params:i,scope:t}),a.req},exports.attach=e=>{let t;[e,t]=l(e,1);let{source:r,effect:a,mapParams:n}=e,s=m(e,t);W(s,'attached',1);let f,{runner:c}=D(s).scope,d=ge(((e,t,a)=>{let i,{params:l,req:f,handler:c}=e,d=s.finally,u=at(l,f,0,d,a),p=a.a,m=M(c),h=1;if(n?[h,i]=rt(n,u,[l,p]):i=r&&m?p:l,h){if(!m)return e.args=[p,i],1;o({target:c,params:{params:i,req:{rs:at(l,f,1,d,a),rj:u}},page:a.page,defer:1})}}),1,1);if(r){let e;C(r)?(e=r,Z(e,[s])):(e=u(r),Z(s,[e])),f=[ye(P(e)),d]}else f=[d];c.seq.splice(1,0,...f),s.use(a);let p=B(a);return p&&(Object.assign(H(s),i(s.shortName,p)),s.defaultConfig.parent=p),Xe(a,s,"effect"),s},exports.clearNode=Ge,exports.combine=u,exports.createApi=(...t)=>{let[[r,a],n]=l(t),o={};return e(a,((e,t)=>{let a=o[t]=c(t,{parent:B(r),config:n});r.on(a,e),Xe(r,a)})),o},exports.createDomain=function r(a,s){let i=n({family:{type:"domain"},regional:1}),l={history:{},graphite:i,hooks:{}};i.meta=Ye("domain",l,a,s),e({Event:c,Effect:m,Store:d,Domain:r},((e,r)=>{let a=r.toLowerCase(),n=c({named:`on${r}`});l.hooks[a]=n;let s=new Set;l.history[`${a}s`]=s,n.create=e=>(o(n,e),e),z(D(n).seq,ge(((e,t,r)=>(r.scope=null,e)))),n.watch((e=>{Z(l,[e]),s.add(e),e.ownerSet||(e.ownerSet=s),B(e)||(e.parent=l)})),Z(l,[n]),l[`onCreate${r}`]=e=>(t(s,e),n.watch(e)),l[`create${r}`]=l[a]=(t,r)=>n(e(t,{parent:l,or:r}))}));let f=B(l);return f&&e(l.hooks,((e,t)=>Ke(e,f.hooks[t]))),l},exports.createEffect=m,exports.createEvent=c,exports.createNode=n,exports.createStore=d,exports.createStoreObject=(...e)=>(F(0,'createStoreObject','combine'),u(...e)),exports.createWatch=({unit:e,fn:t,scope:r})=>{let a=[ve.run({fn:e=>t(e)})];if(r){let t=n({node:a}),o=e.graphite.id,s=r.additionalLinks,i=s[o]||[];return s[o]=i,i.push(t),v((()=>{let e=i.indexOf(t);-1!==e&&i.splice(e,1),Ge(t)}))}{let t=n({node:a,parent:[e],family:{owners:e}});return v((()=>{Ge(t)}))}},exports.fork=(e,a)=>{let o,s=e;N(e)&&(o=e,s=a);let i=(e=>{let r=n({scope:{defers:[],inFlight:0,fxID:0},node:[ge(((e,t,r)=>{B(r)?'dec'===T(B(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),me({priority:"sampler",batch:1}),ge(((e,r)=>{let{defers:a,fxID:n}=r;r.inFlight>0||0===a.length||Promise.resolve().then((()=>{r.fxID===n&&t(a.splice(0,a.length),(e=>{_e(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),a=n({node:[ge(((e,t,r)=>{let a=B(r);if(a){let t=a.node;if(!T(t,'isCombine')||B(a)&&'combine'!==T(B(a).node,'op')){let a=L(r),n=t.scope.state.id,o=T(t,'sid');a.sidIdMap[o]=n,a.sidValuesMap[o]=e}}}))]}),o=n({node:[ge(((e,t,r)=>{let a=L(r);if(a){let e=B(r);e&&(!T(e.node,'isCombine')||B(e)&&'combine'!==T(B(e).node,'op'))&&(a.warnSerialize=1)}}))]}),s={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},getState(e){if('current'in e)return Ve(Re,s,null,e).current;let t=D(e);return Ve(Re,s,t,t.scope.state,1).current},kind:"scope",graphite:n({family:{type:"domain",links:[r,a,o]},meta:{unit:'fork'},scope:{forkInFlightCounter:r}}),additionalLinks:{},handlers:{},fxCount:r,storeChange:a,warnSerializeNode:o};return s})(o);if(s){if(s.values){let e=b(s.values,(e=>r(C(e),'Values map can contain only stores as keys')));Object.assign(i.sidValuesMap,e)}s.handlers&&(i.handlers=b(s.handlers,(e=>r(M(e),"Handlers map can contain only effects as keys"))))}return i},exports.forward=e=>{let t='forward',[{from:r,to:a},o]=l(e,1);return se(r,t,'"from"'),se(a,t,'"to"'),ie(t,a,'to'),Je(n({parent:r,child:a,meta:{op:t,config:o},family:{},regional:1}))},exports.fromObservable=e=>{ne(e);let t=x in e?e[x]():e;r(t.subscribe,'expect observable to have .subscribe');let a=c(),n=Je(a);return t.subscribe({next:a,error:n,complete:n}),a},exports.guard=(...e)=>{let[[t,r],a]=l(e);return r||(r=t,t=r.source),g(r,'guard'),lt('guard',r.clock,t,r.filter,r.target,null,r.name,a,!r.greedy,0,1)},exports.hydrate=(e,{values:t})=>{r(te(t),'values property should be an object');let a,n,s,i=b(t),l=Object.getOwnPropertyNames(i),f=[],c=[];A(e)?(a=e,s=1,r(a.cloneOf,'scope should be created from domain'),n=D(a.cloneOf)):N(e)?n=D(e):r(0,'first argument of hydrate should be domain or scope'),y(n,((e,t)=>{O(l,t)&&(z(f,e),z(c,i[t]))})),o({target:f,params:c,scope:a}),s&&Object.assign(a.sidValuesMap,i)},exports.is=I,exports.launch=o,exports.merge=h,exports.restore=(t,r,a)=>{if(C(t))return F(0,'restore($store)'),t;if($(t)||M(t)){let e=B(t),n=d(r,{parent:e,name:t.shortName,and:a});return Ke(M(t)?t.doneData:t,n),e&&e.hooks.store(n),n}let n=Array.isArray(t)?[]:{};return e(t,((e,t)=>n[t]=C(e)?e:d(e,{name:t}))),n},exports.sample=(...e)=>{let t,r,a,n,[[o,s,i],f]=l(e),c=1;return ae(s)&&te(o)&&g(o,"sample")&&(s=o.clock,i=o.fn,c=!o.greedy,n=o.filter,t=o.target,r=o.name,a=o.sid,o=o.source),lt("sample",s,o,n,t,i,r,f,c,1,0,a)},exports.scopeBind=(e,{scope:t}={})=>{r(t||qe,'scopeBind cannot be called outside of forked .watch');let a=t||qe;return M(e)?t=>{let r=p();return o({target:e,params:{params:t,req:r},scope:a}),r.req}:t=>(o({target:e,params:t,scope:a}),t)},exports.serialize=(t,a={})=>{t.warnSerialize&&console.error('There is a store without sid in this scope, its value is omitted');let n=a.ignore?a.ignore.map((({sid:e})=>e)):[],o={};return e(t.sidValuesMap,((e,r)=>{if(O(n,r))return;let a=t.sidIdMap[r];o[r]=a&&a in t.reg?t.reg[a].current:e})),'onlyChanges'in a&&!a.onlyChanges&&(r(t.cloneOf,'scope should be created from domain'),y(D(t.cloneOf),((e,r)=>{r in o||O(n,r)||T(e,'isCombine')||'ignore'===T(e,'serialize')||(o[r]=t.getState(e))}))),o},exports.setStoreName=(e,t)=>{e.shortName=t,Object.assign(H(e),i(t,B(e)))},exports.split=(...t)=>{let a,o,s='split',[[i,d],u]=l(t),p=!d;p&&(a=i.cases,d=i.match,o=i.clock,i=i.source);let m=C(d),h=!S(d)&&re(d),g=!m&&!h&&te(d);a||(a={}),p?e(a,((e,t)=>ie(s,e,`cases.${t}`))):(r(g,'match should be an object'),e(d,((e,t)=>a[t]=c({derived:1,and:u}))),a.__=c({derived:1,and:u}));let y,b=new Set([].concat(i,o||[],Object.values(a))),v=Object.keys(m||h?a:d);if(m||h)m&&b.add(d),y=[m&&ye(P(d),0,1),me({safe:m,filter:1,pure:!m,fn(e,t,r){let a=String(m?r.a:d(e));dt(t,O(v,a)?a:'__',e,r)}})];else if(g){let t=xe({});t.type='shape';let r,a=[];e(d,((e,n)=>{if(S(e)){r=1,z(a,n),b.add(e);let o=Ke(e,[],[ye(t),ge(((e,t,{a:r})=>r[n]=e))]);if(C(e)){t.current[n]=e.getState();let r=P(e);we(t,{from:r,field:n,type:'field'}),f('splitMatchStore',r,o)}}})),r&&f('splitBase',t),y=[r&&ye(t,0,1),be(((e,t,r)=>{for(let n=0;n<v.length;n++){let o=v[n];if(O(a,o)?r.a[o]:d[o](e))return void dt(t,o,e,r)}dt(t,'__',e,r)}),1)]}else r(0,'expect match to be unit, function or object');let x=n({meta:{op:s},parent:o?[]:i,scope:a,node:y,family:{owners:Array.from(b)},regional:1});if(o&&lt(s,o,i,null,x,null,s,u,0,0,0),!p)return a},exports.step=ve,exports.version="22.3.0",exports.withFactory=({sid:e,name:t,loc:r,method:o,fn:s})=>a(n({meta:{sidRoot:Y(e),name:t,loc:r,method:o}}),s),exports.withRegion=a;
//# sourceMappingURL=effector.cjs.js.map
